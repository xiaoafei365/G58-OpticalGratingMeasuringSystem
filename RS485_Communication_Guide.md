# RS485通讯功能修正指南

## 概述

根据您提供的RS485-MODBUS通讯地址文档，我已经对现有的RS485通讯功能进行了全面的修正和优化。

## 主要修正内容

### 1. 寄存器地址修正

**原有问题**: 寄存器地址使用的是十进制20，与文档不符
**修正方案**: 更新为文档规定的16进制地址

| 功能 | 原地址 | 修正后地址 | 说明 |
|------|--------|------------|------|
| 当前值 | 20 | 0x1000 | RAH:寄存器高位字节, RAL:寄存器低位字节 |
| 比例系数 | - | 0x1002 | 范围: 1~29999 (0.0001~2.9999) |
| 包络直径 | - | 0x1004 | 范围: 1~40000mm |
| 多段补偿值 | - | 0x1006 | 范围: 0~9000mm |
| 测量方向 | - | 0x2000 | 范围: 0~1 |
| 自校正 | - | 0x2001 | 无范围限制 |

### 2. 通讯参数修正

**原有配置**:
```ini
[COM]
port = 3
baud = 9600
```

**修正后配置**:
```ini
[COM]
port = COM3
baudrate = 9600
timeout = 1.0
data_bits = 8
stop_bits = 1
parity = None
protocol = RS485
format = RTU
```

### 3. 功能码实现

- **读取功能码 0x03**: 读取保持寄存器
- **写入功能码 0x06**: 写单个寄存器
- **写入功能码 0x10**: 写多个寄存器

### 4. CRC校验优化

实现了标准的CRC-16-ANSI算法，确保数据传输的可靠性。

## 修正后的文件

### 1. 主程序文件
- `optical_grating_web_system.py` - 更新了ModbusCommunication类

### 2. 配置文件
- `ProductSetup.ini` - 更新了通讯参数和寄存器地址
- `ProductSetup_RS485_Corrected.ini` - 完整的修正版配置文件

### 3. 测试工具
- `test_rs485_communication.py` - RS485通讯功能测试脚本

## 使用方法

### 1. 更新配置文件

将现有的`ProductSetup.ini`文件备份，然后使用修正后的配置：

```bash
# 备份原配置
cp ProductSetup.ini ProductSetup_backup.ini

# 使用修正后的配置
cp ProductSetup_RS485_Corrected.ini ProductSetup.ini
```

### 2. 运行通讯测试

```bash
python test_rs485_communication.py
```

测试脚本会：
- 测试所有配置的从机地址
- 验证各种寄存器的读取功能
- 测试写入功能
- 生成详细的测试报告

### 3. 查看测试结果

测试完成后会生成：
- 控制台输出的实时测试结果
- `rs485_test.log` - 详细的测试日志
- `rs485_test_report.txt` - 测试报告

## 常见问题排查

### 1. 串口连接问题

**症状**: 串口初始化失败
**排查步骤**:
1. 检查串口号是否正确 (COM1, COM2, COM3等)
2. 确认串口未被其他程序占用
3. 检查串口驱动是否正常安装

**解决方案**:
```ini
[COM]
port = COM1  # 根据实际情况修改
```

### 2. 波特率不匹配

**症状**: 能连接但读取数据异常
**排查步骤**:
1. 确认设备的波特率设置
2. 尝试不同的波特率 (4800, 9600, 19200, 38400, 57600)

**解决方案**:
```ini
[COM]
baudrate = 9600  # 根据设备实际波特率设置
```

### 3. 从机地址错误

**症状**: 特定设备无响应
**排查步骤**:
1. 确认设备的从机地址设置
2. 检查地址是否与配置文件一致
3. 确认地址范围在1-247之间

**解决方案**:
```ini
[Channel_1LeftGrating]
slaveaddress = 11  # 根据设备实际地址设置
```

### 4. 寄存器地址错误

**症状**: 读取到错误数据或无数据
**排查步骤**:
1. 确认寄存器地址是否正确
2. 检查寄存器数量设置
3. 验证设备是否支持该寄存器

**解决方案**:
使用文档规定的正确地址：
```ini
regaddress = 0x1000  # 当前值寄存器
regcount = 2         # 寄存器数量
```

## 性能优化建议

### 1. 通讯间隔设置

```ini
[RoundDisplay]
readslavetimeinterval = 200  # 读取间隔(ms)，可根据需要调整
```

### 2. 超时设置

```ini
[COM]
timeout = 1.0  # 通讯超时时间(秒)
```

### 3. 延时设置

```ini
[COM]
presenddelay = 10    # 发送前延时(ms)
prereceivedelay = 10 # 接收前延时(ms)
```

## 验证步骤

1. **配置验证**: 确认配置文件参数正确
2. **连接测试**: 运行测试脚本验证基本连接
3. **功能测试**: 测试读取和写入功能
4. **稳定性测试**: 长时间运行验证稳定性
5. **性能测试**: 测试通讯速度和响应时间

## 技术支持

如果在使用过程中遇到问题：

1. 查看测试日志文件 `rs485_test.log`
2. 检查设备硬件连接
3. 确认设备配置参数
4. 联系技术支持提供详细的错误信息

## 更新记录

- **v1.0** (2024-08-08): 根据RS485-MODBUS通讯地址文档完成初始修正
  - 更新寄存器地址映射
  - 修正通讯参数配置
  - 添加完整的读写功能
  - 实现CRC校验
  - 创建测试工具和诊断指南
